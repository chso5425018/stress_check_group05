<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIストレス診断 - Direct Access Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&family=Noto+Sans+JP:wght@400;700&display=swap');
        body { font-family: 'Inter', 'Noto Sans JP', sans-serif; display: none; }
        .fade-in { animation: fadeIn 0.5s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .loading-shimmer {
            background: linear-gradient(90deg, #f1f5f9 25%, #e2e8f0 50%, #f1f5f9 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
        }
        @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
    </style>
</head>
<body class="bg-slate-50 text-slate-900">

<script>
    const CLASS_PASSWORD = "5425_gakumon_group05"; 

    // ▼▼▼ ここにあなたのAPIキーを貼り付けてください ▼▼▼
    const activeApiKey = "AIzaSyDdtrxapZkgLvzSvVphkV_lhUMumvpdkeE"; 
    // ▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲

    function checkAccess() {
        if (sessionStorage.getItem('isAuthorized') === 'true') {
            document.body.style.display = "block";
            return;
        }
        const enteredPassword = prompt("受講生専用パスワードを入力してください：");
        if (enteredPassword === CLASS_PASSWORD) {
            sessionStorage.setItem('isAuthorized', 'true');
            document.body.style.display = "block";
        } else {
            alert("パスワードが違います。");
            window.location.href = "about:blank";
        }
    }
    checkAccess();
</script>

<div id="app">
    <div id="welcome-screen" class="min-h-screen flex items-center justify-center p-4">
        <div class="max-w-2xl w-full bg-white rounded-3xl shadow-xl overflow-hidden fade-in">
            <div class="bg-slate-900 p-10 text-white text-center">
                <div class="inline-block p-4 bg-white/10 rounded-2xl mb-4 text-emerald-400">
                    <i data-lucide="zap" class="w-12 h-12"></i>
                </div>
                <h1 class="text-3xl font-extrabold mb-2 tracking-tight">AIストレス診断サイト</h1>
                <p class="opacity-70 text-sm">あなたのスコアをAIが精密分析し、行動を設計します。</p>
            </div>
            <div class="p-10 space-y-6">
                <div class="flex items-start gap-4 p-4 bg-emerald-50 rounded-2xl border border-emerald-100">
                    <i data-lucide="check-circle" class="text-emerald-500 w-6 h-6 shrink-0"></i>
                    <div>
                        <p class="text-sm font-bold text-emerald-900">システム準備完了</p>
                        <p class="text-xs text-slate-500 leading-relaxed mt-1">
                            AI分析サーバーと接続されています。すぐに診断を開始できます。
                        </p>
                    </div>
                </div>

                <div class="space-y-3">
                    <button onclick="startTest()" class="w-full bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-4 rounded-xl transition-all shadow-lg flex items-center justify-center gap-2">
                        診断を開始する
                        <i data-lucide="play"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="test-screen" class="hidden min-h-screen flex flex-col items-center py-12 px-4">
        <div class="max-w-xl w-full">
            <div class="mb-8">
                <div class="flex justify-between items-end mb-2">
                    <span id="category-badge" class="text-xs font-bold text-slate-500 bg-slate-200 px-3 py-1 rounded-full uppercase tracking-widest">Category</span>
                    <span class="text-sm text-slate-400 font-medium"><span id="current-count">1</span> / 70</span>
                </div>
                <div class="w-full bg-slate-200 h-1.5 rounded-full overflow-hidden">
                    <div id="progress-bar" class="bg-slate-900 h-full transition-all duration-300" style="width: 0%"></div>
                </div>
            </div>
            <div class="bg-white rounded-3xl shadow-sm p-10 mb-6 border border-slate-200 fade-in">
                <h2 id="question-text" class="text-xl font-bold leading-relaxed mb-10 text-slate-800">質問を読み込んでいます...</h2>
                <div class="grid gap-3" id="answer-buttons">
                    <button onclick="submitAnswer(4)" class="w-full p-5 rounded-xl border border-slate-200 hover:bg-slate-900 hover:text-white text-left font-bold transition-all">強くそう思う</button>
                    <button onclick="submitAnswer(3)" class="w-full p-5 rounded-xl border border-slate-200 hover:bg-slate-900 hover:text-white text-left font-bold transition-all">まあまあそう思う</button>
                    <button onclick="submitAnswer(2)" class="w-full p-5 rounded-xl border border-slate-200 hover:bg-slate-900 hover:text-white text-left font-bold transition-all">あまり思わない</button>
                    <button onclick="submitAnswer(1)" class="w-full p-5 rounded-xl border border-slate-200 hover:bg-slate-900 hover:text-white text-left font-bold transition-all">全く思わない</button>
                </div>
            </div>
        </div>
    </div>

    <div id="result-screen" class="hidden min-h-screen py-12 px-4">
        <div class="max-w-4xl mx-auto">
            <div class="text-center mb-10">
                <h2 class="text-3xl font-black text-slate-900 mb-2">診断結果レポート</h2>
                <p id="result-date" class="text-slate-400 text-xs uppercase tracking-widest font-bold"></p>
            </div>
            <div class="grid md:grid-cols-2 gap-8 mb-8">
                <div class="bg-white p-8 rounded-3xl border border-slate-200 shadow-sm">
                    <h3 class="font-bold text-lg mb-6 flex items-center gap-2">
                        <i data-lucide="bar-chart-3" class="text-indigo-500"></i> ストレス傾向
                    </h3>
                    <canvas id="radarChart"></canvas>
                </div>
                <div class="bg-white p-8 rounded-3xl border border-slate-200 shadow-sm flex flex-col">
                    <h3 class="font-bold text-lg mb-4 flex items-center gap-2">
                        <i data-lucide="sparkles" class="text-amber-500"></i> AIアドバイス
                    </h3>
                    <div id="ai-loading" class="space-y-4">
                        <div class="h-24 w-full loading-shimmer rounded-2xl"></div>
                        <div class="h-4 w-full loading-shimmer rounded-md"></div>
                    </div>
                    <div id="ai-result" class="hidden">
                        <div id="status-box" class="p-5 rounded-2xl mb-6 font-black text-center text-xl"></div>
                        <p id="advice-text" class="text-slate-600 text-sm leading-relaxed mb-8 border-l-4 border-slate-100 pl-4 italic"></p>
                        <div id="action-plan" class="space-y-3"></div>
                    </div>
                </div>
            </div>
            <div class="text-center">
                <button onclick="location.reload()" class="bg-white border border-slate-200 text-slate-500 hover:text-slate-900 px-8 py-3 rounded-full text-xs font-bold transition-all shadow-sm">再診断</button>
            </div>
        </div>
    </div>
</div>

<script>
    const CATEGORIES = { psy: '心理的負荷', phy: '身体的反応', soc: '環境要因' };
    const QUESTIONS = Array.from({ length: 70 }, (_, i) => ({
        id: i + 1,
        text: ["最近、理由もなくイライラすることがありますか？", "十分な睡眠をとっても疲れが取れませんか？", "周囲の人とのコミュニケーションに負担を感じますか？", "自分の将来に対して不安を感じることがありますか？"][i % 4] + ` (Q${i+1})`,
        category: ['psy', 'phy', 'soc'][i % 3]
    }));

    let currentIdx = 0;
    let answers = {};

    window.onload = () => {
        // キーの入力チェックロジックを削除し、アイコンの初期化のみ行います
        lucide.createIcons();
    };

    function hideAll() { ['welcome-screen', 'test-screen', 'result-screen'].forEach(id => document.getElementById(id).classList.add('hidden')); }
    
    function startTest() {
        hideAll();
        document.getElementById('test-screen').classList.remove('hidden');
        updateQuestion();
    }

    function updateQuestion() {
        const q = QUESTIONS[currentIdx];
        document.getElementById('question-text').innerText = q.text;
        document.getElementById('category-badge').innerText = CATEGORIES[q.category];
        document.getElementById('current-count').innerText = currentIdx + 1;
        document.getElementById('progress-bar').style.width = `${((currentIdx + 1) / 70) * 100}%`;
    }

    function submitAnswer(val) {
        answers[QUESTIONS[currentIdx].id] = val;
        if (currentIdx < 69) { currentIdx++; updateQuestion(); }
        else { renderResult(); }
    }

    async function renderResult() {
        hideAll();
        document.getElementById('result-screen').classList.remove('hidden');
        document.getElementById('result-date').innerText = new Date().toLocaleDateString('ja-JP', { year: 'numeric', month: 'long', day: 'numeric' });

        const scores = { psy: 0, phy: 0, soc: 0 };
        Object.entries(answers).forEach(([id, val]) => { scores[QUESTIONS[id-1].category] += val; });
        const chartData = [Math.round((scores.psy/96)*100), Math.round((scores.phy/92)*100), Math.round((scores.soc/92)*100)];

        new Chart(document.getElementById('radarChart'), {
            type: 'radar',
            data: { labels: ['心理', '身体', '環境'], datasets: [{ data: chartData, backgroundColor: 'rgba(79, 70, 229, 0.1)', borderColor: 'rgb(79, 70, 229)', borderWidth: 2 }] },
            options: { scales: { r: { min: 0, max: 100, ticks: { display: false } } }, plugins: { legend: { display: false } } }
        });

        await fetchAIAdvice(chartData);
    }

    async function fetchAIAdvice(scores) {
        // キーが空欄、または書き換え忘れのチェック
        if (!activeApiKey || activeApiKey.includes("ここに")) {
            alert("APIキーが設定されていません。コード内の activeApiKey を確認してください。");
            showErrorAdvice();
            return;
        }

        const prompt = `分析：心理${scores[0]}%, 身体${scores[1]}%, 環境${scores[2]}%。JSON形式回答：{"status":"良好/注意/警戒","color":"bg-emerald-50 text-emerald-700等","advice":"診断総評","actions":["行動1","行動2"]}`;
        
        // 空白除去などの安全対策をしてURLを作成
        const baseUrl = "https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent";
        const finalUrl = `${baseUrl}?key=${activeApiKey.trim()}`;

        console.log("通信開始: " + finalUrl.replace(activeApiKey.trim(), "HIDDEN_KEY")); // ログにはキーを隠して表示

        try {
            const res = await fetch(finalUrl, {
                method: 'POST', // ★ここ重要：必ずPOSTで送る
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    contents: [{ parts: [{ text: prompt }] }], 
                    generationConfig: { responseMimeType: "application/json" } 
                })
            });

            if (!res.ok) {
                // ここで400や403が出たら詳細を表示
                const errorDetail = await res.json();
                console.error("APIエラー:", errorDetail);
                alert("エラーが発生しました。F12のConsoleを確認してください。");
                showErrorAdvice();
                return;
            }

            const json = await res.json();
            // JSONパースの安全対策
            const textContent = json.candidates[0].content.parts[0].text;
            displayAI(JSON.parse(textContent));

        } catch (e) { 
            console.error("通信失敗:", e);
            showErrorAdvice(); 
        }
    }

    function displayAI(data) {
        document.getElementById('ai-loading').classList.add('hidden');
        document.getElementById('ai-result').classList.remove('hidden');
        const statusBox = document.getElementById('status-box');
        statusBox.innerText = data.status;
        statusBox.className = `p-5 rounded-2xl mb-6 font-black text-center text-xl ${data.color}`;
        document.getElementById('advice-text').innerText = data.advice;
        document.getElementById('action-plan').innerHTML = data.actions.map(a => `<div class="p-3 bg-slate-50 rounded-xl text-xs font-bold border border-slate-100 shadow-sm">・ ${a}</div>`).join('');
    }

    function showErrorAdvice() {
        displayAI({ status: "通信エラー", color: "bg-red-50 text-red-700", advice: "AIサーバーとの通信に失敗しました。時間をおいて再試行してください。", actions: ["再読み込み"] });
    }
</script>
</body>
</html>