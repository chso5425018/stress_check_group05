<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MENTALYZE - Student Stress Check</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;800&family=Noto+Sans+JP:wght@400;500;700&display=swap');
        
        :root {
            /* PDF指定のカラー定義 */
            --color-brand-primary: #007BFF;   /* チャート/データ */
            --color-brand-secondary: #28A745; /* チェック/成長 */
            --color-text-logo: #343A40;       /* ロゴ文字 */
            --color-background: #F8F9FA;      /* 背景 */
        }

        body { 
            font-family: 'Inter', 'Noto Sans JP', sans-serif; 
            display: none; 
            background-color: var(--color-background);
            color: var(--color-text-logo);
        }

        /* ブランドカラー適用クラス */
        .text-brand-primary { color: var(--color-brand-primary); }
        .bg-brand-primary { background-color: var(--color-brand-primary); }
        .hover\:bg-brand-primary-dark:hover { background-color: #0069d9; } /* 少し暗く */
        
        .text-brand-secondary { color: var(--color-brand-secondary); }
        .bg-brand-secondary { background-color: var(--color-brand-secondary); }
        
        .text-brand-dark { color: var(--color-text-logo); }

        .fade-in { animation: fadeIn 0.6s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        
        .loading-shimmer {
            background: linear-gradient(90deg, #f1f5f9 25%, #e2e8f0 50%, #f1f5f9 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
        }
        @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
        
        .card-hover:hover { transform: translateY(-4px); box-shadow: 0 12px 24px -8px rgba(0, 123, 255, 0.15); }

        /* ロゴ用スタイリング */
        .logo-font { font-family: 'Inter', sans-serif; letter-spacing: -0.02em; }
    </style>
</head>
<body>

<script>
    const CLASS_PASSWORD = "5425_gakumon_group05"; 

    // ▼▼▼ ここにあなたのAPIキーを貼り付けてください ▼▼▼
    const activeApiKey = "AIzaSyASv8JKWJ98xOiUkGP7U3n2pCNvLFhHtXA"; 
    // ▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲

    function checkAccess() {
        if (sessionStorage.getItem('isAuthorized') === 'true') {
            document.body.style.display = "block";
            return;
        }
        const enteredPassword = prompt("受講生専用パスワードを入力してください：");
        if (enteredPassword === CLASS_PASSWORD) {
            sessionStorage.setItem('isAuthorized', 'true');
            document.body.style.display = "block";
        } else {
            alert("パスワードが違います。");
            window.location.href = "about:blank";
        }
    }
    checkAccess();
</script>

<div id="app">
    <!-- ウェルカム画面 -->
    <div id="welcome-screen" class="min-h-screen flex flex-col items-center justify-center p-6 relative overflow-hidden">
        <!-- 背景装飾 -->
        <div class="absolute top-0 left-0 w-full h-full overflow-hidden -z-10">
            <div class="absolute top-[-10%] right-[-5%] w-[500px] h-[500px] rounded-full bg-blue-100/50 blur-3xl"></div>
            <div class="absolute bottom-[-10%] left-[-5%] w-[400px] h-[400px] rounded-full bg-green-100/40 blur-3xl"></div>
        </div>

        <div class="max-w-5xl w-full grid lg:grid-cols-2 gap-12 items-center fade-in">
            <!-- 左側: ブランドメッセージ -->
            <div class="space-y-8 text-center lg:text-left">
                <!-- ロゴマーク -->
                <div class="flex items-center justify-center lg:justify-start gap-3 mb-6">
                    <div class="relative w-12 h-12">
                        <i data-lucide="radar" class="w-12 h-12 text-brand-primary absolute inset-0"></i>
                        <div class="absolute -bottom-1 -right-1 bg-white rounded-full p-0.5 shadow-sm">
                            <i data-lucide="check-circle-2" class="w-6 h-6 text-brand-secondary fill-white"></i>
                        </div>
                    </div>
                    <h1 class="text-3xl font-extrabold text-brand-dark logo-font tracking-tight">MENTALYZE</h1>
                </div>

                <div class="space-y-4">
                    <h2 class="text-4xl lg:text-5xl font-extrabold text-slate-900 leading-tight">
                        ポジティブな可視化で、<br>
                        <span class="text-brand-primary">行動変容</span>を加速する。
                    </h2>
                    <p class="text-lg text-slate-600 leading-relaxed">
                        MENTALYZEは、大学生特有のストレス要因を75項目で詳細に分析。<br>
                        ただの測定で終わらせず、あなたの「次の一歩」を科学的にサポートします。
                    </p>
                </div>

                <div class="flex flex-col sm:flex-row gap-4 justify-center lg:justify-start pt-4">
                    <button onclick="startTest()" class="bg-brand-primary hover:bg-brand-primary-dark text-white font-bold py-4 px-8 rounded-full transition-all shadow-lg hover:shadow-blue-500/30 flex items-center justify-center gap-2 text-lg group">
                        診断を開始する
                        <i data-lucide="arrow-right" class="group-hover:translate-x-1 transition-transform"></i>
                    </button>
                    <div class="flex items-center gap-2 text-slate-500 text-sm px-4 py-4">
                        <i data-lucide="clock" class="w-4 h-4"></i> 所要時間: 約3分
                    </div>
                </div>
            </div>

            <!-- 右側: ビジュアルカード -->
            <div class="relative hidden lg:block">
                <div class="bg-white rounded-3xl shadow-2xl p-8 border border-slate-100 relative z-10 transform rotate-2 hover:rotate-0 transition-transform duration-500">
                    <!-- モックアップグラフ -->
                    <div class="flex justify-between items-center mb-6">
                        <div class="space-y-1">
                            <div class="h-2 w-20 bg-slate-200 rounded"></div>
                            <div class="h-4 w-32 bg-slate-800 rounded"></div>
                        </div>
                        <div class="w-10 h-10 rounded-full bg-blue-50 flex items-center justify-center text-brand-primary">
                            <i data-lucide="activity"></i>
                        </div>
                    </div>
                    <div class="space-y-4">
                        <div class="flex items-center gap-3">
                            <div class="w-full bg-slate-100 h-3 rounded-full overflow-hidden">
                                <div class="bg-brand-primary h-full w-[70%]"></div>
                            </div>
                            <span class="text-xs font-bold text-brand-primary">70%</span>
                        </div>
                        <div class="flex items-center gap-3">
                            <div class="w-full bg-slate-100 h-3 rounded-full overflow-hidden">
                                <div class="bg-brand-secondary h-full w-[45%]"></div>
                            </div>
                            <span class="text-xs font-bold text-brand-secondary">45%</span>
                        </div>
                        <div class="flex items-center gap-3">
                            <div class="w-full bg-slate-100 h-3 rounded-full overflow-hidden">
                                <div class="bg-slate-400 h-full w-[60%]"></div>
                            </div>
                            <span class="text-xs font-bold text-slate-500">60%</span>
                        </div>
                    </div>
                    <!-- フローティング要素 -->
                    <div class="absolute -bottom-6 -left-6 bg-white p-4 rounded-xl shadow-lg border border-slate-100 flex items-center gap-3">
                        <div class="w-10 h-10 rounded-full bg-green-100 flex items-center justify-center text-brand-secondary">
                            <i data-lucide="sprout"></i>
                        </div>
                        <div>
                            <p class="text-xs text-slate-500">Action Plan</p>
                            <p class="font-bold text-slate-800">リフレッシュ推奨</p>
                        </div>
                    </div>
                </div>
                <!-- 背景の装飾円 -->
                <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-[120%] h-[120%] border border-slate-200 rounded-full -z-10 opacity-50"></div>
                <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-[140%] h-[140%] border border-slate-100 rounded-full -z-20 opacity-30"></div>
            </div>
        </div>
        
        <div class="absolute bottom-6 text-center w-full text-xs text-slate-400">
            © 2026 MENTALYZE Student Support System. All rights reserved.
        </div>
    </div>

    <!-- テスト画面 -->
    <div id="test-screen" class="hidden min-h-screen flex flex-col items-center py-12 px-4 bg-[#F8F9FA]">
        <div class="max-w-xl w-full">
            <div class="mb-8">
                <div class="flex justify-between items-end mb-2">
                    <span id="category-badge" class="text-xs font-bold text-brand-primary bg-blue-50 px-3 py-1 rounded-full uppercase tracking-widest">Category</span>
                    <span class="text-sm text-slate-400 font-medium"><span id="current-count">1</span> / 75</span>
                </div>
                <div class="w-full bg-slate-200 h-1.5 rounded-full overflow-hidden">
                    <div id="progress-bar" class="bg-brand-primary h-full transition-all duration-300" style="width: 0%"></div>
                </div>
            </div>
            <div class="bg-white rounded-3xl shadow-lg p-8 sm:p-10 mb-6 border border-slate-100 fade-in relative overflow-hidden">
                <div class="absolute top-0 left-0 w-1.5 h-full bg-brand-primary"></div>
                <h2 id="question-text" class="text-xl font-bold leading-relaxed mb-10 text-slate-800">質問を読み込んでいます...</h2>
                <div class="grid gap-3" id="answer-buttons">
                    <!-- JSでボタンを生成します -->
                </div>
            </div>
        </div>
    </div>

    <!-- 結果画面 -->
    <div id="result-screen" class="hidden min-h-screen py-12 px-4 bg-[#F8F9FA]">
        <div class="max-w-4xl mx-auto">
            <div class="text-center mb-10">
                <div class="flex items-center justify-center gap-2 mb-2">
                    <i data-lucide="radar" class="w-6 h-6 text-brand-primary"></i>
                    <span class="font-bold text-slate-700 logo-font">MENTALYZE REPORT</span>
                </div>
                <h2 class="text-3xl font-black text-slate-900 mb-2">診断結果レポート</h2>
                <p id="result-date" class="text-slate-400 text-xs uppercase tracking-widest font-bold"></p>
            </div>
            <div class="grid md:grid-cols-2 gap-8 mb-8">
                <div class="bg-white p-8 rounded-3xl border border-slate-200 shadow-sm">
                    <h3 class="font-bold text-lg mb-6 flex items-center gap-2">
                        <i data-lucide="bar-chart-3" class="text-brand-primary"></i> ストレス傾向
                    </h3>
                    <div class="relative">
                        <canvas id="radarChart"></canvas>
                    </div>
                </div>
                <div class="bg-white p-8 rounded-3xl border border-slate-200 shadow-sm flex flex-col">
                    <h3 class="font-bold text-lg mb-4 flex items-center gap-2">
                        <i data-lucide="sparkles" class="text-yellow-500"></i> AIアドバイス
                    </h3>
                    <div id="ai-loading" class="space-y-4">
                        <div class="h-24 w-full loading-shimmer rounded-2xl"></div>
                        <div class="h-4 w-full loading-shimmer rounded-md"></div>
                    </div>
                    <div id="ai-result" class="hidden">
                        <div id="status-box" class="p-5 rounded-2xl mb-6 font-black text-center text-xl"></div>
                        <p id="advice-text" class="text-slate-600 text-sm leading-relaxed mb-8 border-l-4 border-slate-100 pl-4 italic"></p>
                        <div id="action-plan" class="space-y-3"></div>
                    </div>
                </div>
            </div>
            
            <!-- アクションボタンエリア -->
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 max-w-2xl mx-auto">
                <button onclick="showActionPlan()" class="col-span-1 sm:col-span-2 group bg-brand-secondary hover:bg-green-600 text-white px-8 py-4 rounded-xl text-lg font-bold transition-all shadow-md flex items-center justify-center gap-3">
                    <i data-lucide="lightbulb" class="w-6 h-6"></i> 
                    <div>
                        <span class="block text-xs font-normal opacity-90">次にやること</span>
                        おすすめのアクションプランを見る
                    </div>
                    <i data-lucide="arrow-right" class="group-hover:translate-x-1 transition-transform ml-auto"></i>
                </button>
                
                <button onclick="showComparison()" class="group bg-white border-2 border-blue-100 hover:border-brand-primary hover:text-brand-primary text-slate-600 px-6 py-3 rounded-xl text-sm font-bold transition-all flex items-center justify-center gap-2">
                    <i data-lucide="users"></i> 他の大学生と比較
                </button>
                <button onclick="location.reload()" class="bg-white border-2 border-slate-100 hover:border-slate-400 text-slate-500 hover:text-slate-700 px-6 py-3 rounded-xl text-sm font-bold transition-all flex items-center justify-center gap-2">
                    <i data-lucide="rotate-ccw"></i> 再診断
                </button>
            </div>
        </div>
    </div>

    <!-- アクションプラン提案画面 -->
    <div id="action-plan-screen" class="hidden min-h-screen py-12 px-4 bg-[#F8F9FA]">
        <div class="max-w-4xl mx-auto fade-in">
            <button onclick="backToResult()" class="flex items-center text-slate-500 hover:text-brand-primary transition-colors text-sm font-bold mb-6">
                <i data-lucide="chevron-left" class="mr-1 w-4 h-4"></i> 結果トップに戻る
            </button>
            
            <div class="text-center mb-10">
                <div class="inline-block p-3 bg-green-100 text-brand-secondary rounded-full mb-4">
                    <i data-lucide="sprout" class="w-8 h-8"></i>
                </div>
                <h2 class="text-2xl font-black text-slate-800 mb-2">あなたへのおすすめアクション</h2>
                <p class="text-slate-500 text-sm">診断結果に基づき、今日から始められる具体的なアクションを提案します。</p>
            </div>

            <div id="recommended-actions-container" class="space-y-8">
                <!-- JSで動的に挿入 -->
            </div>

            <div class="mt-12 text-center">
                <button onclick="toggleAllActions()" class="text-sm font-bold text-slate-400 hover:text-brand-primary flex items-center justify-center gap-2 mx-auto transition-colors">
                    <i data-lucide="list"></i> すべてのアクションリストを見る
                </button>
            </div>
            
            <div id="all-actions-container" class="hidden mt-8 pt-8 border-t border-slate-200">
                <h3 class="text-lg font-bold text-slate-700 mb-6 text-center">全アクションリスト (30選)</h3>
                <div id="all-actions-list" class="grid md:grid-cols-2 gap-4">
                    <!-- JSで挿入 -->
                </div>
            </div>
        </div>
    </div>

    <!-- 集団比較画面 -->
    <div id="comparison-screen" class="hidden min-h-screen py-12 px-4 bg-[#F8F9FA]">
        <div class="max-w-4xl mx-auto fade-in">
            <!-- ナビゲーション -->
            <button onclick="backToResult()" class="flex items-center text-slate-500 hover:text-brand-primary transition-colors text-sm font-bold mb-6">
                <i data-lucide="chevron-left" class="mr-1 w-4 h-4"></i> 結果トップに戻る
            </button>

            <!-- メイン比較カード -->
            <div class="bg-white rounded-3xl shadow-lg overflow-hidden border border-slate-200 mb-8">
                <div class="p-6 border-b border-slate-100 bg-slate-50/50 flex justify-between items-center">
                    <div>
                        <h3 class="text-xl font-bold text-slate-800 flex items-center gap-2">
                            <i data-lucide="bar-chart-2" class="text-brand-primary"></i> 学生平均との比較
                        </h3>
                        <p class="text-xs text-slate-500 mt-1">あなたのスコア(%) vs 大学生の平均値(推計)</p>
                    </div>
                </div>

                <div class="p-8">
                    <!-- グラフエリア -->
                    <div class="relative h-80 w-full">
                        <canvas id="comparisonChart"></canvas>
                    </div>
                    <div class="mt-6 flex justify-center gap-6 text-xs font-bold text-slate-500">
                        <div class="flex items-center gap-2">
                            <span class="w-3 h-3 bg-brand-primary rounded-sm"></span> あなたのスコア
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="w-3 h-3 bg-slate-300 rounded-sm"></span> 大学生平均
                        </div>
                    </div>
                </div>
            </div>

            <!-- 分析・フィードバック -->
            <div class="grid md:grid-cols-2 gap-6">
                <div class="bg-white p-6 rounded-2xl shadow-sm border-l-4 border-red-400">
                    <h4 class="font-bold text-slate-800 mb-3 flex items-center text-sm">
                        <span class="bg-red-100 text-red-600 px-2 py-0.5 rounded text-xs mr-2">注意</span>
                        平均より高いストレス項目
                    </h4>
                    <ul id="high-stress-list" class="space-y-3 text-sm text-slate-600">
                        <!-- JSで動的に挿入 -->
                        <li class="text-slate-400">特になし</li>
                    </ul>
                </div>

                <div class="bg-white p-6 rounded-2xl shadow-sm border-l-4 border-blue-400">
                    <h4 class="font-bold text-slate-800 mb-3 text-sm">比較分析コメント</h4>
                    <p id="comparison-advice" class="text-sm text-slate-600 leading-relaxed">
                        <!-- JSで動的に挿入 -->
                        全体的に平均的な範囲内です。
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // ターゲットに合わせて文言を調整
    const CATEGORIES = { psy: '心理的負荷 (学業/将来)', phy: '身体的反応 (疲労)', soc: '環境・支援 (人間関係)' };
    
    // 大学生平均データ（%）の仮設定
    const NATIONAL_AVERAGES = {
        psy: 60,
        phy: 45,
        soc: 50
    };

    // ▼ アクションプランデータ
    const ACTION_PLANS = [
        // A. 課題・バイトのコントロールと負荷
        { id: 1, text: "タスクの優先順位付け：緊急度と重要度で課題や予定を分類し、高優先度から着手する（アイゼンハワーマトリクス）。", category: 'psy' },
        { id: 2, text: "ポモドーロ・テクニックの導入：25分集中＋5分休憩を繰り返し、レポート作成などの集中力を維持する。", category: 'psy' },
        { id: 3, text: "To-Doリストの作成：毎日、翌日の講義や課題をリストアップし、やるべきことを「見える化」する。", category: 'psy' },
        { id: 4, text: "「やらないこと」リストの作成：だらだらスマホを見る時間など、減らす時間を明確にする。", category: 'psy' },
        { id: 5, text: "情報のデジタル化：プリントの整理やスケジュール管理をアプリ化し、探し物の時間を減らす。", category: 'psy' },
        { id: 6, text: "周囲との調整：バイトのシフトがきつい時は店長に相談し、試験期間などは調整を交渉する。", category: 'soc' },
        { id: 7, text: "目標の明確化：講義の目的や就活の軸が不明確な場合、先輩やキャリアセンターで相談してゴールを定める。", category: 'psy' },
        { id: 8, text: "得意分野の活用：自分の知識やスキルを活かせるサークル活動やインターンに挑戦する。", category: 'soc' },
        { id: 9, text: "意見反映の工夫：ゼミやサークルで改善案を出す際は、具体的なメリットを添えて提案してみる。", category: 'soc' },

        // B. ストレス反応とリフレッシュ
        { id: 10, text: "深呼吸（腹式呼吸）：不安や緊張を感じた時、4秒吸って8秒吐く呼吸法で自律神経を整える。", category: 'phy' },
        { id: 11, text: "マインドフルネス瞑想：1日5分、呼吸に意識を集中し「今ここ」に意識を向ける練習をする。", category: 'phy' },
        { id: 12, text: "質の高い睡眠の確保：就寝1時間前はスマホを控え、睡眠の質を高める。", category: 'phy' },
        { id: 13, text: "デジタルデトックス：週末の数時間は通知をオフにし、意識的に情報を遮断する。", category: 'psy' },
        { id: 14, text: "自然との触れ合い：キャンパス内の緑や近くの公園を散歩し、五感を通してリラックスする。", category: 'phy' },
        { id: 15, text: "定期的な運動：週に2〜3回、軽いジョギングや筋トレなど体を動かす習慣をつける。", category: 'phy' },
        { id: 16, text: "胃腸への配慮：食欲がない時は消化に良いものを摂り、食事のリズムを整える。", category: 'phy' },
        { id: 17, text: "水分補給：頭痛やだるさ対策として、水やお茶をこまめに摂取する。", category: 'phy' },
        { id: 18, text: "アサーティブな表現：イライラした時、相手を尊重しつつ「私はこう感じた」と自分の気持ちを伝える。", category: 'psy' },
        { id: 19, text: "専門家への相談：ゆううつや不安が続く場合、大学の学生相談室やカウンセリングを利用する。", category: 'psy' },

        // C. 周囲のサポートと環境
        { id: 20, text: "感謝を伝える：ノートを見せてくれた友人などに、具体的に「ありがとう」を伝える。", category: 'soc' },
        { id: 21, text: "先生/先輩との対話：研究や進路について、教授や先輩に定期的にフィードバックを求める。", category: 'soc' },
        { id: 22, text: "ランチ/雑談の活用：学食や部室で、課題以外のたわいない話をする時間を大切にする。", category: 'soc' },
        { id: 23, text: "相談の練習：小さな悩み（履修登録など）から、友人に相談する練習をする。", category: 'soc' },
        { id: 24, text: "サードプレイスの確保：大学と自宅以外に、自分が落ち着けるカフェや図書館などの場所を見つける。", category: 'soc' },
        { id: 25, text: "SOSの出し方：本当に辛い時は「助けて」と言っていいと自分に許可を出す。", category: 'soc' },
        { id: 26, text: "ハラスメント対策：アカハラやバイト先での理不尽な扱いには、記録を取り相談窓口へ行く。", category: 'soc' },
        { id: 27, text: "情報の共有：就活や試験情報を一人で抱え込まず、仲間と共有して助け合う。", category: 'soc' },
        { id: 28, text: "多様な価値観への接触：他学部や学外の人と交流し、狭い人間関係の視点を広げる。", category: 'soc' },
        { id: 29, text: "ワークライフバランス：バイト/サークル/学業のバランスを見直し、無理なスケジュールは断る。", category: 'soc' },
        { id: 30, text: "「理想の一日」の実践：ストレスが少ない理想のスケジュールを想像し、週に一つ実行してみる。", category: 'psy' }
    ];

    // 質問項目 (全75問)
    const QUESTIONS = [
        // A. ストレス要因 (1-17)
        { id: 1, text: "課題やレポート、バイトなどの量が非常に多い", category: 'psy' },
        { id: 2, text: "提出期限やシフトに追われて時間が足りない", category: 'psy' },
        { id: 3, text: "学業やバイトで一生懸命働かなければならない", category: 'psy' },
        { id: 4, text: "講義や作業中、かなり注意を集中する必要がある", category: 'psy' },
        { id: 5, text: "授業の内容や研究が難しく、ついていくのが大変だ", category: 'psy' },
        { id: 6, text: "大学やバイトにいる間は、常に緊張している", category: 'psy' },
        { id: 7, text: "通学やバイト、サークル活動で体力を消耗する", category: 'phy' },
        { id: 8, text: "自分のペースで履修計画や活動を進められる", category: 'soc' },
        { id: 9, text: "課題や活動の進め方を自分で決めることができる", category: 'soc' },
        { id: 10, text: "ゼミやサークルの運営方針に自分の意見を反映できる", category: 'soc' },
        { id: 11, text: "自分の得意なことや知識を活かす場面が少ない", category: 'soc' },
        { id: 12, text: "ゼミやサークル、バイト先で意見の対立がある", category: 'soc' },
        { id: 13, text: "所属しているグループや学科の雰囲気が合わない", category: 'soc' },
        { id: 14, text: "大学やバイト先の雰囲気は友好的である", category: 'soc' },
        { id: 15, text: "活動環境(教室、部室、バイト先など)は快適ではない", category: 'soc' },
        { id: 16, text: "専攻している内容や活動は自分に合っている", category: 'soc' },
        { id: 17, text: "今の学生生活（勉強・課外活動）にやりがいを感じている", category: 'soc' },
        
        // B. 最近1か月間の状態 (18-46)
        { id: 18, text: "活気がわいてくる", category: 'psy' },
        { id: 19, text: "元気がいっぱいだ", category: 'psy' },
        { id: 20, text: "生き生きする", category: 'psy' },
        { id: 21, text: "怒りを感じる", category: 'psy' },
        { id: 22, text: "内心腹立たしい", category: 'psy' },
        { id: 23, text: "イライラしている", category: 'psy' },
        { id: 24, text: "ひどく疲れた", category: 'phy' },
        { id: 25, text: "へとへとだ", category: 'phy' },
        { id: 26, text: "だるい", category: 'phy' },
        { id: 27, text: "気がはりつめている", category: 'psy' },
        { id: 28, text: "将来や進路のことが不安だ", category: 'psy' }, 
        { id: 29, text: "落着かない", category: 'psy' },
        { id: 30, text: "ゆううつだ", category: 'psy' },
        { id: 31, text: "何をするのも面倒だ", category: 'psy' },
        { id: 32, text: "講義や作業に集中できない", category: 'psy' },
        { id: 33, text: "気分が晴れない", category: 'psy' },
        { id: 34, text: "勉強や課題が手につかない", category: 'psy' },
        { id: 35, text: "悲しいと感じる", category: 'psy' },
        { id: 36, text: "めまいがする", category: 'phy' },
        { id: 37, text: "体のふしぶしが痛む", category: 'phy' },
        { id: 38, text: "頭が重かったり頭痛がする", category: 'phy' },
        { id: 39, text: "首筋や肩がこる", category: 'phy' },
        { id: 40, text: "腰が痛い", category: 'phy' },
        { id: 41, text: "目が疲れる", category: 'phy' },
        { id: 42, text: "動悸や息切れがする", category: 'phy' },
        { id: 43, text: "胃腸の具合が悪い", category: 'phy' },
        { id: 44, text: "食欲がない", category: 'phy' },
        { id: 45, text: "便秘や下痢をする", category: 'phy' },
        { id: 46, text: "よく眠れない", category: 'phy' },

        // C. 周囲のサポート (47-55)
        { id: 47, text: "先生や先輩、バイト先の上司と気軽に話ができますか?", category: 'soc' },
        { id: 48, text: "友人や同級生、バイト仲間と気軽に話ができますか?", category: 'soc' },
        { id: 49, text: "家族や地元の友達、恋人等と気軽に話ができますか?", category: 'soc' },
        { id: 50, text: "困った時、先生や先輩、上司は頼りになりますか?", category: 'soc' },
        { id: 51, text: "困った時、友人や同級生、仲間は頼りになりますか?", category: 'soc' },
        { id: 52, text: "困った時、家族や地元の友達、恋人等は頼りになりますか?", category: 'soc' },
        { id: 53, text: "個人的な問題を相談したら、先生や先輩、上司はきいてくれますか?", category: 'soc' },
        { id: 54, text: "個人的な問題を相談したら、友人や同級生はきいてくれますか?", category: 'soc' },
        { id: 55, text: "個人的な問題を相談したら、家族や地元の友達、恋人等はきいてくれますか?", category: 'soc' },

        // D. 満足度 (56-57)
        { id: 56, text: "大学生活（学業・課外活動）に満足だ", category: 'soc' },
        { id: 57, text: "プライベート（趣味や生活）に満足だ", category: 'soc' },

        // 追加項目 (58-70)
        { id: 58, text: "講義や研究の目的・意義が不明確だと感じることが多い", category: 'psy' },
        { id: 59, text: "成績評価や活動の成果に対して正当な評価が得られている", category: 'soc' },
        { id: 60, text: "履修登録や就活などに必要な情報が十分に提供されている", category: 'soc' },
        { id: 61, text: "学業・バイトとプライベートのバランスが取れている", category: 'soc' },
        { id: 62, text: "将来の進路や就活について、周囲から十分な支援を受けている", category: 'soc' },
        { id: 63, text: "大学やバイト先で不公平な扱いを受けていると感じる", category: 'soc' },
        { id: 64, text: "アカハラやバイト先でのハラスメントを経験したことがある", category: 'soc' },
        { id: 65, text: "自分の意見や提案を尊重してくれている", category: 'soc' },
        { id: 66, text: "所属するコミュニティ（大学・サークル等）に愛着がある", category: 'soc' },
        { id: 67, text: "今の専攻や活動に対し、意欲的である", category: 'psy' },
        { id: 68, text: "大学生活を通じて成長できていると感じる", category: 'psy' },
        { id: 69, text: "今の生活が楽しく、つい時間を忘れて没頭してしまうことがある", category: 'psy' },
        { id: 70, text: "このまま今の進路・目標に向かって進む自信がある", category: 'psy' },

        // 行動変容 (71-75)
        { id: 71, text: "ストレスを感じた時、具体的な解決策を3つ以上書き出して検討する時間を持っていますか。", category: 'psy' },
        { id: 72, text: "疲れていると感じた時、勉強や活動を中断し、15分以上リラックスできる休憩を意識的に取っていますか。", category: 'phy' },
        { id: 73, text: "最近一ヶ月で、勉強や進路、人間関係の悩みを友人や家族、先生などに具体的に相談しましたか。", category: 'soc' },
        { id: 74, text: "ストレスが少ない「理想的な一日のスケジュール」を具体的に想像し、その実現のために週に一つでも行動を試みていますか。", category: 'psy' },
        { id: 75, text: "自分の気分転換方法（趣味、運動、読書など）を3つ以上持っており、そのうち最低一つを週に一回以上実行していますか。", category: 'psy' }
    ];

    let currentIdx = 0;
    let answers = {};
    let lastChartData = null; 
    let comparisonChartInstance = null;

    function retryAI() {
        if (!lastChartData) return;
        document.getElementById('ai-result').classList.add('hidden');
        document.getElementById('ai-loading').classList.remove('hidden');
        fetchAIAdvice(lastChartData);
    }

    window.onload = () => {
        lucide.createIcons();
    };

    function hideAll() { 
        ['welcome-screen', 'test-screen', 'result-screen', 'comparison-screen', 'action-plan-screen'].forEach(id => {
            const el = document.getElementById(id);
            if(el) el.classList.add('hidden');
        }); 
    }
    
    function startTest() {
        hideAll();
        document.getElementById('test-screen').classList.remove('hidden');
        updateQuestion();
    }

    function updateQuestion() {
        const q = QUESTIONS[currentIdx];
        document.getElementById('question-text').innerText = q.text;
        document.getElementById('category-badge').innerText = CATEGORIES[q.category];
        document.getElementById('current-count').innerText = currentIdx + 1;
        document.getElementById('progress-bar').style.width = `${((currentIdx + 1) / QUESTIONS.length) * 100}%`;

        const answerContainer = document.getElementById('answer-buttons');
        
        if (currentIdx >= 70) {
            // 行動変容質問用の2択ボタン (はい=1点, いいえ=4点)
            answerContainer.innerHTML = `
                <button onclick="submitAnswer(1)" class="w-full p-6 rounded-xl border border-blue-100 bg-blue-50 hover:bg-blue-100 text-center font-bold transition-all text-xl shadow-sm text-brand-primary">
                    はい<br><span class="text-xs font-normal opacity-80">(実行している・あてはまる)</span>
                </button>
                <button onclick="submitAnswer(4)" class="w-full p-6 rounded-xl border border-slate-200 hover:bg-slate-100 text-center font-bold transition-all text-xl shadow-sm text-slate-600">
                    いいえ<br><span class="text-xs font-normal opacity-80">(実行していない・あてはまらない)</span>
                </button>
            `;
        } else {
            // 通常の4択ボタン
            answerContainer.innerHTML = `
                <button onclick="submitAnswer(4)" class="w-full p-5 rounded-xl border border-slate-200 hover:bg-blue-50 text-left font-bold transition-all text-slate-700">そうだ（強くそう思う）</button>
                <button onclick="submitAnswer(3)" class="w-full p-5 rounded-xl border border-slate-200 hover:bg-blue-50 text-left font-bold transition-all text-slate-700">まあそうだ</button>
                <button onclick="submitAnswer(2)" class="w-full p-5 rounded-xl border border-slate-200 hover:bg-blue-50 text-left font-bold transition-all text-slate-700">ちがう（あまり思わない）</button>
                <button onclick="submitAnswer(1)" class="w-full p-5 rounded-xl border border-slate-200 hover:bg-blue-50 text-left font-bold transition-all text-slate-700">全くちがう</button>
            `;
        }
    }

    function submitAnswer(val) {
        answers[QUESTIONS[currentIdx].id] = val;
        if (currentIdx < QUESTIONS.length - 1) { 
            currentIdx++; 
            updateQuestion(); 
        } else { 
            renderResult(); 
        }
    }

    async function renderResult() {
        hideAll();
        document.getElementById('result-screen').classList.remove('hidden');
        document.getElementById('result-date').innerText = new Date().toLocaleDateString('ja-JP', { year: 'numeric', month: 'long', day: 'numeric' });

        const scores = { psy: 0, phy: 0, soc: 0 };
        const maxScores = { psy: 0, phy: 0, soc: 0 }; 

        QUESTIONS.forEach(q => {
            if (answers[q.id]) {
                scores[q.category] += answers[q.id];
                maxScores[q.category] += 4; 
            }
        });

        const chartData = [
            Math.round((scores.psy / maxScores.psy) * 100) || 0,
            Math.round((scores.phy / maxScores.phy) * 100) || 0,
            Math.round((scores.soc / maxScores.soc) * 100) || 0
        ];

        new Chart(document.getElementById('radarChart'), {
            type: 'radar',
            data: { 
                labels: ['心理的負荷', '身体的反応', '環境・支援'], 
                datasets: [{ 
                    data: chartData, 
                    backgroundColor: 'rgba(0, 123, 255, 0.2)',  // brand-primary
                    borderColor: '#007BFF', 
                    borderWidth: 2,
                    pointBackgroundColor: '#007BFF'
                }] 
            },
            options: { 
                scales: { 
                    r: { 
                        min: 0, max: 100, 
                        ticks: { display: false },
                        pointLabels: { font: { size: 12, weight: 'bold', family: "'Inter', sans-serif" } }
                    } 
                }, 
                plugins: { legend: { display: false } } 
            }
        });

        lastChartData = chartData; 
        await fetchAIAdvice(chartData);
        saveResult(scores, chartData);
    }

    function showActionPlan() {
        if (!lastChartData) return;
        
        hideAll();
        document.getElementById('action-plan-screen').classList.remove('hidden');

        // スコアの取得 (psy, phy, soc)
        const scores = {
            psy: lastChartData[0],
            phy: lastChartData[1],
            soc: lastChartData[2]
        };

        const priorities = Object.entries(scores).sort(([,a], [,b]) => b - a);
        const topCategory = priorities[0][0]; 
        const secondCategory = priorities[1][0]; 

        let recommendedActions = [];
        const getActionsByCat = (cat) => ACTION_PLANS.filter(a => a.category === cat);
        const getRandom = (arr, n) => arr.sort(() => 0.5 - Math.random()).slice(0, n);

        recommendedActions = [
            ...getRandom(getActionsByCat(topCategory), 3),
            ...getRandom(getActionsByCat(secondCategory), 2),
            ...getRandom(getActionsByCat(priorities[2][0]), 1)
        ];

        const container = document.getElementById('recommended-actions-container');
        container.innerHTML = recommendedActions.map((action, index) => {
            let icon, colorClass, categoryTitle;
            if (action.category === 'psy') {
                icon = 'brain'; colorClass = 'bg-blue-100 text-brand-primary'; categoryTitle = '心理・メンタルケア';
            } else if (action.category === 'phy') {
                icon = 'battery-charging'; colorClass = 'bg-rose-100 text-rose-600'; categoryTitle = '身体・リフレッシュ';
            } else {
                icon = 'users'; colorClass = 'bg-amber-100 text-amber-600'; categoryTitle = '環境・サポート';
            }

            return `
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 flex gap-4 card-hover transition-all animate-fade-in" style="animation-delay: ${index * 100}ms">
                    <div class="shrink-0 w-12 h-12 rounded-xl ${colorClass} flex items-center justify-center">
                        <i data-lucide="${icon}"></i>
                    </div>
                    <div>
                        <div class="text-xs font-bold uppercase tracking-wider text-slate-400 mb-1">${categoryTitle}</div>
                        <h3 class="font-bold text-slate-800 text-lg leading-snug">${action.text}</h3>
                    </div>
                </div>
            `;
        }).join('');

        const allList = document.getElementById('all-actions-list');
        allList.innerHTML = ACTION_PLANS.map(action => `
            <div class="p-4 rounded-xl border border-slate-100 bg-white text-sm text-slate-600">
                <span class="font-bold text-slate-800 block mb-1">Action ${action.id}</span>
                ${action.text}
            </div>
        `).join('');

        lucide.createIcons();
    }

    function toggleAllActions() {
        const container = document.getElementById('all-actions-container');
        container.classList.toggle('hidden');
    }

    function showComparison() {
        if (!lastChartData) return;
        
        hideAll();
        document.getElementById('comparison-screen').classList.remove('hidden');

        const myData = lastChartData;
        const avgData = [NATIONAL_AVERAGES.psy, NATIONAL_AVERAGES.phy, NATIONAL_AVERAGES.soc];
        const labels = ['心理的負荷', '身体的反応', '環境・支援'];

        const ctx = document.getElementById('comparisonChart').getContext('2d');
        if (comparisonChartInstance) comparisonChartInstance.destroy();

        comparisonChartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: 'あなたのスコア',
                        data: myData,
                        backgroundColor: '#007BFF', // brand-primary
                        borderRadius: 6,
                        barPercentage: 0.6,
                        categoryPercentage: 0.8
                    },
                    {
                        label: '大学生平均',
                        data: avgData,
                        backgroundColor: '#cbd5e1', 
                        borderRadius: 6,
                        barPercentage: 0.6,
                        categoryPercentage: 0.8
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: { beginAtZero: true, max: 100, grid: { color: '#f1f5f9' }, ticks: { stepSize: 20 } },
                    x: { grid: { display: false } }
                },
                plugins: {
                    legend: { display: false }, 
                    tooltip: {
                        backgroundColor: 'rgba(255, 255, 255, 0.95)',
                        titleColor: '#1e293b',
                        bodyColor: '#475569',
                        borderColor: '#e2e8f0',
                        borderWidth: 1,
                        padding: 12,
                        cornerRadius: 12,
                        displayColors: true,
                        boxPadding: 4
                    }
                }
            }
        });

        analyzeComparison(myData, avgData);
    }

    function analyzeComparison(myData, avgData) {
        const labels = ['心理的負荷', '身体的反応', '環境・支援'];
        const highStressItems = [];
        
        myData.forEach((score, idx) => {
            if (score >= avgData[idx] + 10) {
                highStressItems.push({
                    name: labels[idx],
                    diff: score - avgData[idx]
                });
            }
        });

        const listEl = document.getElementById('high-stress-list');
        if (highStressItems.length > 0) {
            listEl.innerHTML = highStressItems.map(item => 
                `<li class="flex items-center justify-between pb-3 border-b border-red-50 last:border-0 last:pb-0">
                    <span class="font-bold text-slate-700">${item.name}</span>
                    <span class="bg-red-100 text-red-600 font-bold px-2 py-1 rounded text-xs">+${item.diff}pt</span>
                 </li>`
            ).join('');
        } else {
            listEl.innerHTML = '<li class="text-slate-400 text-xs py-2">平均より著しく高い項目はありません。<br>良好なコンディションです。</li>';
        }

        const adviceEl = document.getElementById('comparison-advice');
        if (highStressItems.length === 0) {
            adviceEl.innerHTML = "全項目において、平均と同等またはそれ以下のスコアです。<strong class='text-brand-primary'>非常にバランスの取れた良好な状態</strong>と言えます。今のリズムを大切にしつつ、余力があれば新しい活動に挑戦してみるのも良いでしょう。";
        } else if (highStressItems.some(i => i.name.includes('心理'))) {
            adviceEl.innerHTML = "<strong>心理的な負担</strong>が平均より高めです。課題や進路のプレッシャーを感じていませんか？ 一人で抱え込まず、友人や学生相談室などを活用して、気持ちをアウトプットする時間を作りましょう。";
        } else if (highStressItems.some(i => i.name.includes('身体'))) {
            adviceEl.innerHTML = "<strong>身体的な疲労</strong>が蓄積しているようです。バイトやサークル、課題で睡眠時間が削られていませんか？ 今週は「何もしない時間」を意識的に作り、身体を休めることを優先してください。";
        } else {
            adviceEl.innerHTML = "<strong>環境や人間関係のストレス</strong>を感じている可能性があります。研究室やバイト先でのコミュニケーションに負担を感じていませんか？ 無理に合わせすぎず、信頼できる友人や家族に愚痴を聞いてもらうだけでも楽になります。";
        }
    }

    function backToResult() {
        hideAll();
        document.getElementById('result-screen').classList.remove('hidden');
    }

    function saveResult(scores, chartData) {
        const history = JSON.parse(localStorage.getItem('stress_history') || '[]');
        const newRecord = {
            date: new Date().toISOString(),
            scores: scores,
            chartData: chartData
        };
        history.push(newRecord);
        localStorage.setItem('stress_history', JSON.stringify(history));
    }

    async function fetchAIAdvice(scores) {
        if (!activeApiKey || activeApiKey.includes("ここに")) {
            alert("APIキーが設定されていません。コード内の activeApiKey を確認してください。");
            showErrorAdvice();
            return;
        }

        const prompt = `あなたは大学生のメンタルヘルス専門のアドバイザーです。以下のストレスチェック結果に基づき、学生に寄り添ったJSON形式のアドバイスを作成してください。
        
        【対象】
        日本の大学生（学業、アルバイト、就活、サークル、人間関係などの悩みを持つ）

        【診断結果】
        - 心理的ストレス(不安・怒り・課題負荷): ${scores[0]}%
        - 身体的ストレス(疲労・生活リズム): ${scores[1]}%
        - 環境・社会的支援(友人・先輩・家族のサポート): ${scores[2]}%
        ※数値が高いほどストレスが高い、または支援が不足しています。

        【回答フォーマット(JSON)】
        {
            "status": "短い診断名（例：お疲れ気味のアカデミック戦士、要リフレッシュ、絶好調のキャンパスライフ、など学生向けにキャッチーに）",
            "color": "TailwindCSSのクラス文字列（例：bg-red-50 text-red-700、bg-amber-50 text-amber-700、bg-blue-50 text-brand-primary）",
            "advice": "150文字程度で、学生生活の文脈（授業、バイト、進路など）を交えた共感的かつ具体的なアドバイス。",
            "actions": ["今日からできる具体的な行動1（学生向け）", "行動2", "行動3"]
        }`;
        
        const baseUrl = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent";
        const finalUrl = `${baseUrl}?key=${activeApiKey.trim()}`;

        console.log("AI分析リクエスト送信...");

        try {
            const res = await fetch(finalUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    contents: [{ parts: [{ text: prompt }] }], 
                    generationConfig: { responseMimeType: "application/json" } 
                })
            });

            if (!res.ok) {
                const errorDetail = await res.json();
                console.error("APIエラー:", errorDetail);
                throw new Error("API Request Failed");
            }

            const json = await res.json();
            const textContent = json.candidates[0].content.parts[0].text;
            displayAI(JSON.parse(textContent));

        } catch (e) { 
            console.error("通信失敗:", e);
            showErrorAdvice(); 
        }
    }

    function displayAI(data) {
        document.getElementById('ai-loading').classList.add('hidden');
        document.getElementById('ai-result').classList.remove('hidden');
        const statusBox = document.getElementById('status-box');
        statusBox.innerText = data.status;
        statusBox.className = `p-5 rounded-2xl mb-6 font-black text-center text-xl ${data.color}`;
        document.getElementById('advice-text').innerText = data.advice;
        document.getElementById('action-plan').innerHTML = data.actions.map(a => `<div class="p-3 bg-slate-50 rounded-xl text-xs font-bold border border-slate-100 shadow-sm flex items-start gap-2"><i data-lucide="check" class="w-4 h-4 text-brand-primary shrink-0 mt-0.5"></i><span>${a}</span></div>`).join('');
        lucide.createIcons();
    }

    function showErrorAdvice() {
        document.getElementById('ai-loading').classList.add('hidden');
        document.getElementById('ai-result').classList.remove('hidden');
        const statusBox = document.getElementById('status-box');
        statusBox.innerText = "通信エラー";
        statusBox.className = "p-5 rounded-2xl mb-6 font-black text-center text-xl bg-red-50 text-red-700 border border-red-100";
        const adviceDiv = document.getElementById('advice-text');
        adviceDiv.innerHTML = `
            <div class="flex flex-col items-center justify-center gap-4 py-4">
                <p class="text-center text-red-600 font-bold">AIサーバーとの接続に失敗しました。<br>Wi-Fiなどを確認して、もう一度試してみてね。</p>
                <button onclick="retryAI()" class="bg-brand-primary hover:bg-brand-primary-dark text-white font-bold py-3 px-8 rounded-full transition-all shadow-lg flex items-center gap-2 transform hover:scale-105">
                    <i data-lucide="refresh-cw"></i> 再試行する
                </button>
            </div>
        `;
        document.getElementById('action-plan').innerHTML = "";
        lucide.createIcons();
    }
</script>
</body>
</html>